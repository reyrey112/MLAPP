services:

  django-mlapp:
    # build: 
    #   context: .
    #   dockerfile: ./django_dockerfile
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/django-mlapp:prod
    environment:
      - DATABASE_URL=postgresql://${DJANGO_POSTGRES_USER}:${DJANGO_POSTGRES_PASSWORD}@mlapp_db:5432/${DJANGO_POSTGRES_DB}
      - ZENML_STORE_URL=http://zenml_server:8080
      - ZENML_STORE_USERNAME=${ZENML_STORE_USERNAME}
      - ZENML_STORE_PASSWORD=${ZENML_STORE_PASSWORD}
      - MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME}
      - MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD}
      - MLFLOW_FLASK_SERVER_SECRET_KEY='password'
      - MLFLOW_EXPERIMENT_NAME=${MLFLOW_EXPERIMENT_NAME}
      # - MLFLOW_TRACKING_INSECURE_TLS=true

    ports:
      - "${DJANGO_PORT}:8000"
    volumes:
      - mlapp-user_files:/app/user_files
      - mlapp-.config:/root/.config
    depends_on:
      mlapp_db:
        condition: service_healthy
      zenml_server:
        condition: service_healthy
      # mlflow_service:
      #   condition: service_healthy

  mlapp_db:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/django1611:latest
    ports:
      - 5429:5432
    environment:
      - POSTGRES_USER=${DJANGO_POSTGRES_USER}
      - POSTGRES_PASSWORD=${DJANGO_POSTGRES_PASSWORD}
      - POSTGRES_DB=${DJANGO_POSTGRES_DB}
    volumes:
      - mlapp-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  zenml_server:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/zenml-mlapp:prod
    ports:
      - ${ZENML_PORT}:8080
    environment:
      - ZENML_STORE_URL=mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@zenml_db:3306/${MYSQL_DATABASE}
    depends_on:
      zenml_db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s

    

  zenml_db:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/mysql80:latest
    ports:
      - ${ZENML_DB_PORT}:3306
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    volumes:
      - zenml-mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5

  mlflow_service:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/mlflow-mlapp:latest
    ports: 
      - ${MLFLOW_PORT}:5000
    environment:
      - MLFLOW_FLASK_SERVER_SECRET_KEY='password'
      # - MLFLOW_TRACKING_INSECURE_TLS=true
    volumes:
      - mlflow-artifacts:/mlartifacts
    command: >
      bash -c "pip install mlflow[auth] psycopg2-binary && mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri=postgresql://${MLFLOW_POSTGRES_USER}:${MLFLOW_POSTGRES_PASSWORD}@mlflow_db:5432/${MLFLOW_POSTGRES_DB} --app-name basic-auth"
    depends_on:
      - mlflow_db
    # restart: unless-stopped

  mlflow_db:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/django1611:latest
    ports:
      - ${MLFLOW_DB_PORT}:5432
    environment:
      - POSTGRES_USER=${MLFLOW_POSTGRES_USER}
      - POSTGRES_PASSWORD=${MLFLOW_POSTGRES_PASSWORD}
      - POSTGRES_DB=${MLFLOW_POSTGRES_DB}
    volumes:
      - mlflow-postgres-data:/var/lib/postgresql/data
volumes:
  mlflow-postgres-data:
  zenml-mysql-data:
  mlapp-postgres-data:
  mlapp-user_files:
  mlapp-.config:
  mlflow-artifacts:

